name: Pull Request Checks

on:
  pull_request:
    branches: [ main, master, develop ]
  push:
    branches: [ main, master, develop ]

jobs:
  lint:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [22.17.1]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linting
      run: npm run lint

    - name: Check code formatting
      run: |
        # Check if code is properly formatted
        npm run lint --

  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [22.17.1]

    steps:
    - name: Install Salesforce CLI
      run: |
        echo "Tests steps disabled"

    # - name: Checkout code
    #   uses: actions/checkout@v4

    # - name: Setup Node.js ${{ matrix.node-version }}
    #   uses: actions/setup-node@v4
    #   with:
    #     node-version: ${{ matrix.node-version }}
    #     cache: 'npm'

    # - name: Install Salesforce CLI
    #   run: |
    #     npm install --global @salesforce/cli
    #     sf --version

    # - name: Install dependencies
    #   run: npm ci

    # - name: Run tests
    #   run: npm test

  security:
    runs-on: ubuntu-latest
    needs: [lint, test]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.17.1'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run security audit
      run: npm audit --audit-level=moderate

    - name: Check for outdated dependencies
      run: npm outdated || true

  code-quality:
    runs-on: ubuntu-latest
    needs: [lint, test]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.17.1'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run ESLint with detailed output
      run: npm run lint -- --format=unix --max-warnings=0

    - name: Check bundle size (if applicable)
      run: |
        if [ -f "package.json" ] && grep -q "build" package.json; then
          npm run build
          echo "Bundle size check completed"
        else
          echo "No build script found, skipping bundle size check"
        fi
